<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Validaci√≥n LUP - GASEOSAS LUX SUR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.27/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background-color: #f5f5f5; }
    .container { max-width: 1600px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    h1, h2 { color: #2c3e50; text-align: center; margin-bottom: 5px; }
    .header-info { text-align: center; margin: 10px 0; color: #555; font-size: 0.9em; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 9pt; }
    th, td { border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle; }
    th { background-color: #e9ecef; font-weight: bold; }
    tr:nth-child(even) { background-color: #f8f9fa; }
    .condicion { display: flex; justify-content: center; gap: 10px; }
    .condicion input[type="radio"] { margin: 0; }
    .zona-search-container { text-align: center; margin: 15px 0; position: relative; }
    #zonaSearch { width: 250px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
    #zonaResults { position: absolute; top: 55px; left: 50%; transform: translateX(-50%); width: 250px; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000; }
    #zonaResults div { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
    #zonaResults div:hover { background-color: #f0f0f0; }
    #zonaResults div:last-child { border-bottom: none; }
    .btn { margin: 5px; padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
    #btnCargarZona { background-color: #3498db; color: white; }
    #btnGuardar { background-color: #27ae60; color: white; }
    #btnLimpiar { background-color: #e74c3c; color: white; }
    #btnGenerarPDF { background-color: #9b59b6; color: white; }
    select, textarea { padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 180px; }
    .evidencia { margin: 15px 0; padding: 10px; border: 1px dashed #ccc; border-radius: 6px; background-color: #fafafa; }
    .evidencia label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    .preview-images { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
    .preview-images img { width: 100px; height: auto; border: 1px solid #ddd; border-radius: 4px; }
    .alerta { color: #e74c3c; font-weight: bold; margin: 10px 0; text-align: center; }
    .hidden { display: none; }
    .no-data { color: #999; font-style: italic; }
    @media print {
      body { margin: 0; padding: 0; }
      .container { box-shadow: none; padding: 0; }
      table { font-size: 8pt; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>DEPARTAMENTO DE EMPAQUE Y PRODUCTO</h1>
    <h2>GASEOSAS LUX SUR</h2>
    <h2 style="margin-top: 5px;">INFORME DE LABOR PARA VALIDAR CUMPLIMIENTO DE CONDICIONES EN EL RECIBO DE ZONAS</h2>
    <p style="text-align: center; font-weight: bold; margin: 5px 0;">1- CUMPLE &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&...... 0- NO CUMPLE</p>

    <div class="header-info">
      <strong>FECHA:</strong> <span id="fechaActual">Friday, June 06, 2025</span> &nbsp;&nbsp; 
      <strong>SUPERVISOR:</strong> <input type="text" id="supervisor" placeholder="Nombre del supervisor" style="width: 180px; border: none; border-bottom: 1px solid #000; text-align: center;">
    </div>

    <div class="zona-search-container">
      <label for="zonaSearch"><strong>Buscar ZONA (ej: LS1301):</strong></label>
      <input type="text" id="zonaSearch" placeholder="Escribe para buscar..." autocomplete="off">
      <div id="zonaResults" class="hidden"></div>
    </div>

    <div id="formContainer" class="hidden">
      <table id="tablaPrincipal">
        <thead>
          <tr>
            <th>#</th>
            <th>ZONA</th>
            <th>N¬∞ VH</th>
            <th>CANASTILLA SALE - ENTRA</th>
            <th>ESTIBAS SALE-ENTRA</th>
            <th>REMISION SALE-ENTRA</th>
            <th colspan="3">1. ASEO</th>
            <th colspan="3">2. ENVASE</th>
            <th colspan="3">3. PRODUCTO</th>
            <th>NOVEDAD</th>
          </tr>
          <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th>CABINA</th>
            <th>CARROCER√çA</th>
            <th>ESTIBAS</th>
            <th>UBICACI√ìN</th>
            <th>ARRUMES</th>
            <th>CALIDAD</th>
            <th>UBICACI√ìN</th>
            <th>ORDEN</th>
            <th>CORTINAS</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tablaBody">
          <!-- Rellenado din√°micamente -->
        </tbody>
      </table>

      <div class="evidencia">
        <label for="imagen_derecha">üì∏ Subir foto del LADO DERECHO del veh√≠culo:</label>
        <input type="file" id="imagen_derecha" accept="image/*">
        <div class="preview-images" id="previewDerecha"></div>
      </div>

      <div class="evidencia">
        <label for="imagen_izquierda">üì∏ Subir foto del LADO IZQUIERDO del veh√≠culo:</label>
        <input type="file" id="imagen_izquierda" accept="image/*">
        <div class="preview-images" id="previewIzquierda"></div>
      </div>

      <div style="text-align: center; margin: 20px 0;">
        <button id="btnGuardar" class="btn">üíæ Guardar Validaci√≥n</button>
        <button id="btnLimpiar" class="btn">üóëÔ∏è Limpiar</button>
        <button id="btnGenerarPDF" class="btn">üñ®Ô∏è Generar Reporte PDF</button>
      </div>
    </div>

    <div id="alertaEvidencia" class="alerta hidden">‚ö†Ô∏è Debe subir las fotos del lado derecho e izquierdo del veh√≠culo antes de guardar.</div>
  </div>

  <script>
    // --- DATOS FIJOS ---
    const zonas = [
      "LS1301", "LS1302", "LS1303", "LS1304", "LS1601", "LS1602", "LS1603", "LS1604", "LS1605", "LS1646",
      "LS1801", "LS1802", "LS1803", "LS1804", "LS1805", "LS1806", "LS1807", "LS1808", "LS1809", "LS1810",
      "LS1811", "LS1812", "LS1813", "LS1814", "LS1815", "LS1816", "LS1817", "LS1818", "LS1819", "LS1821",
      "LS1822", "LS1823", "LS1824", "LS1825", "LS1826", "LS1827", "LS1828", "LS1829", "LS1830", "LS1831",
      "LS1832", "LS1833", "LS1834", "LS1835", "LS1836", "LS1837", "LS1838", "LS1839", "LS1840", "LS1841",
      "LS1842", "LS1843", "LS1844", "LS1845", "LS1846", "LS1848", "LS1849", "LS1850", "LS1851", "LS1852",
      "LS1854", "LS1855", "LS1856", "LS1857", "LS1858", "LS1859", "LS1860", "LS1861", "LS1863", "LS1864",
      "LS1867", "LS1868", "LS1869", "LS1870", "LS1871", "LS1872", "LS1873", "LS1874", "LS1875", "LS1876",
      "LS1877", "LS1878", "LS1879", "LS1880", "LS1881", "LS1882", "LS1883", "LS1884", "LS1885", "LS1886",
      "LS1901", "LS1902"
    ];

    const mb51 = {
      "LS1301": { vehiculo: "1653", estibas: 8 },
      "LS1302": { vehiculo: "2422", estibas: 8 },
      "LS1303": { vehiculo: "707", estibas: 6 },
      "LS1304": { vehiculo: "7489", estibas: 13 },
      "LS1601": { vehiculo: "5881", estibas: 10 },
      "LS1602": { vehiculo: "5845", estibas: 10 },
      "LS1603": { vehiculo: "6376", estibas: 10 },
      "LS1604": { vehiculo: "6572", estibas: 8 },
      "LS1605": { vehiculo: "7488", estibas: 12 },
      "LS1646": { vehiculo: "7793", estibas: 8 },
      "LS1801": { vehiculo: "8108", estibas: 8 },
      "LS1802": { vehiculo: "7951", estibas: 7 },
      "LS1803": { vehiculo: "7384", estibas: 10 },
      "LS1804": { vehiculo: "8138", estibas: 10 },
      "LS1805": { vehiculo: "7726", estibas: 8 },
      "LS1806": { vehiculo: "8140", estibas: 11 },
      "LS1807": { vehiculo: "8177", estibas: 10 },
      "LS1808": { vehiculo: "7732", estibas: 9 },
      "LS1809": { vehiculo: "7376", estibas: 11 },
      "LS1810": { vehiculo: "8160", estibas: 9 },
      "LS1811": { vehiculo: "7763", estibas: 13 },
      "LS1812": { vehiculo: "7730", estibas: 10 },
      "LS1813": { vehiculo: "7950", estibas: 12 },
      "LS1814": { vehiculo: "8099", estibas: 10 },
      "LS1815": { vehiculo: "8441", estibas: 10 },
      "LS1816": { vehiculo: "7796", estibas: 13 },
      "LS1817": { vehiculo: "7797", estibas: 8 },
      "LS1818": { vehiculo: "8134", estibas: 8 },
      "LS1819": { vehiculo: "8443", estibas: 12 },
      "LS1821": { vehiculo: "8438", estibas: 8 },
      "LS1822": { vehiculo: "8440", estibas: 7 },
      "LS1823": { vehiculo: "7396", estibas: 9 },
      "LS1824": { vehiculo: "8444", estibas: 10 },
      "LS1825": { vehiculo: "8448", estibas: 10 },
      "LS1826": { vehiculo: "8103", estibas: 10 },
      "LS1827": { vehiculo: "7759", estibas: 8 },
      "LS1828": { vehiculo: "7909", estibas: 10 },
      "LS1829": { vehiculo: "7721", estibas: 10 },
      "LS1830": { vehiculo: "8102", estibas: 13 },
      "LS1831": { vehiculo: "8104", estibas: 10 },
      "LS1832": { vehiculo: "8447", estibas: 8 },
      "LS1833": { vehiculo: "8139", estibas: 11 },
      "LS1834": { vehiculo: "8445", estibas: 11 },
      "LS1835": { vehiculo: "7398", estibas: 14 },
      "LS1836": { vehiculo: "7729", estibas: 12 },
      "LS1837": { vehiculo: "7727", estibas: 13 },
      "LS1838": { vehiculo: "8176", estibas: 8 },
      "LS1839": { vehiculo: "7736", estibas: 11 },
      "LS1840": { vehiculo: "8107", estibas: 10 },
      "LS1841": { vehiculo: "7724", estibas: 9 },
      "LS1842": { vehiculo: "7716", estibas: 8 },
      "LS1843": { vehiculo: "7761", estibas: 8 },
      "LS1844": { vehiculo: "7734", estibas: 9 },
      "LS1845": { vehiculo: "8984", estibas: 11 },
      "LS1846": { vehiculo: "7399", estibas: 11 },
      "LS1848": { vehiculo: "7952", estibas: 10 },
      "LS1849": { vehiculo: "7953", estibas: 10 },
      "LS1850": { vehiculo: "8442", estibas: 10 },
      "LS1851": { vehiculo: "7799", estibas: 9 },
      "LS1852": { vehiculo: "7801", estibas: 10 },
      "LS1854": { vehiculo: "7380", estibas: 13 },
      "LS1855": { vehiculo: "7392", estibas: 9 },
      "LS1856": { vehiculo: "8132", estibas: 10 },
      "LS1857": { vehiculo: "7794", estibas: 7 },
      "LS1858": { vehiculo: "7961", estibas: 9 },
      "LS1859": { vehiculo: "8446", estibas: 9 },
      "LS1860": { vehiculo: "8135", estibas: 8 },
      "LS1861": { vehiculo: "7725", estibas: 9 },
      "LS1863": { vehiculo: "7728", estibas: 8 },
      "LS1864": { vehiculo: "7954", estibas: 8 },
      "LS1867": { vehiculo: "8109", estibas: 11 },
      "LS1868": { vehiculo: "7949", estibas: 2 },
      "LS1869": { vehiculo: "7956", estibas: 9 },
      "LS1870": { vehiculo: "7957", estibas: 11 },
      "LS1871": { vehiculo: "8136", estibas: 10 },
      "LS1872": { vehiculo: "7958", estibas: 4 },
      "LS1873": { vehiculo: "8133", estibas: 9 },
      "LS1874": { vehiculo: "7800", estibas: 10 },
      "LS1875": { vehiculo: "7959", estibas: 9 },
      "LS1876": { vehiculo: "8106", estibas: 11 },
      "LS1877": { vehiculo: "8100", estibas: 10 },
      "LS1878": { vehiculo: "8101", estibas: 7 },
      "LS1879": { vehiculo: "7960", estibas: 11 },
      "LS1880": { vehiculo: "7404", estibas: 11 },
      "LS1881": { vehiculo: "7996", estibas: 7 },
      "LS1882": { vehiculo: "8105", estibas: 8 },
      "LS1883": { vehiculo: "8137", estibas: 11 },
      "LS1884": { vehiculo: "7731", estibas: 0 },
      "LS1885": { vehiculo: "7798", estibas: 10 },
      "LS1886": { vehiculo: "8439", estibas: 9 },
      "LS1901": { vehiculo: "8986", estibas: 4 },
      "LS1902": { vehiculo: "7403", estibas: 10 }
    };

    const novedadesPorZona = {
      "LS1303": "PEDIR 1 FORMATO KFC",
      "LS1901": "PEDIR 1 FORMATO KFC"
    };

    // --- DOM ELEMENTS ---
    const zonaSearch = document.getElementById("zonaSearch");
    const zonaResults = document.getElementById("zonaResults");
    const formContainer = document.getElementById("formContainer");
    const tablaBody = document.getElementById("tablaBody");
    const fechaActual = document.getElementById("fechaActual");
    const supervisorInput = document.getElementById("supervisor");
    const imagenDerecha = document.getElementById("imagen_derecha");
    const imagenIzquierda = document.getElementById("imagen_izquierda");
    const previewDerecha = document.getElementById("previewDerecha");
    const previewIzquierda = document.getElementById("previewIzquierda");
    const btnGuardar = document.getElementById("btnGuardar");
    const btnLimpiar = document.getElementById("btnLimpiar");
    const btnGenerarPDF = document.getElementById("btnGenerarPDF");
    const alertaEvidencia = document.getElementById("alertaEvidencia");

    // --- INICIALIZAR ---
    fechaActual.textContent = new Date().toLocaleDateString('es-ES', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // --- BUSQUEDA EN TIEMPO REAL ---
    zonaSearch.addEventListener("input", () => {
      const query = zonaSearch.value.trim().toUpperCase();
      zonaResults.innerHTML = '';
      zonaResults.classList.add("hidden");

      if (!query) return;

      const matches = zonas.filter(z => z.includes(query));
      if (matches.length === 0) {
        zonaResults.innerHTML = '<div class="no-data">No se encontraron coincidencias</div>';
        zonaResults.classList.remove("hidden");
        return;
      }

      matches.forEach(z => {
        const div = document.createElement("div");
        div.textContent = z;
        div.addEventListener("click", () => {
          zonaSearch.value = z;
          zonaResults.classList.add("hidden");
          cargarZona(z);
        });
        zonaResults.appendChild(div);
      });

      zonaResults.classList.remove("hidden");
    });

    // Al hacer clic fuera del resultado, ocultar
    document.addEventListener("click", (e) => {
      if (!zonaSearch.contains(e.target) && !zonaResults.contains(e.target)) {
        zonaResults.classList.add("hidden");
      }
    });

    function cargarZona(zona) {
      if (!zonas.includes(zona)) return;

      formContainer.classList.remove("hidden");

      // Limpiar tabla y llenar solo la fila seleccionada
      tablaBody.innerHTML = '';
      const idx = zonas.indexOf(zona) + 1;

      // Datos de referencia
      const mb51Data = mb51[zona] || {};

      // Celdas fijas
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${idx}</td>
        <td>${zona}</td>
        <td>${mb51Data.vehiculo || ''}</td>
        <td>2</td>
        <td>${mb51Data.estibas || ''}</td>
        <td>${novedadesPorZona[zona] ? '1' : '0'}</td>
        <td class="condicion"><input type="radio" name="aseo_cabina_${zona}" value="1"> <input type="radio" name="aseo_cabina_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="aseo_carroceria_${zona}" value="1"> <input type="radio" name="aseo_carroceria_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="aseo_estibas_${zona}" value="1"> <input type="radio" name="aseo_estibas_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="envase_ubicacion_${zona}" value="1"> <input type="radio" name="envase_ubicacion_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="envase_arrumes_${zona}" value="1"> <input type="radio" name="envase_arrumes_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="envase_calidad_${zona}" value="1"> <input type="radio" name="envase_calidad_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="producto_ubicacion_${zona}" value="1"> <input type="radio" name="producto_ubicacion_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="producto_orden_${zona}" value="1"> <input type="radio" name="producto_orden_${zona}" value="0"></td>
        <td class="condicion"><input type="radio" name="producto_cortinas_${zona}" value="1"> <input type="radio" name="producto_cortinas_${zona}" value="0"></td>
        <td><textarea rows="1" style="width:100%; resize:none; padding: 4px;">${novedadesPorZona[zona] || ''}</textarea></td>
      `;
      tablaBody.appendChild(row);

      // Cargar datos guardados si existen
      const saved = localStorage.getItem(`lup_validacion_${zona}`);
      if (saved) {
        const data = JSON.parse(saved);
        cargarDatosGuardados(data, zona);
      }

      // Limpiar im√°genes anteriores
      previewDerecha.innerHTML = '';
      previewIzquierda.innerHTML = '';
      imagenDerecha.value = '';
      imagenIzquierda.value = '';
    }

    function cargarDatosGuardados(data, zona) {
      const fields = [
        { key: "aseo_cabina", input: `input[name="aseo_cabina_${zona}"][value="${data.aseo_cabina}"]` },
        { key: "aseo_carroceria", input: `input[name="aseo_carroceria_${zona}"][value="${data.aseo_carroceria}"]` },
        { key: "aseo_estibas", input: `input[name="aseo_estibas_${zona}"][value="${data.aseo_estibas}"]` },
        { key: "envase_ubicacion", input: `input[name="envase_ubicacion_${zona}"][value="${data.envase_ubicacion}"]` },
        { key: "envase_arrumes", input: `input[name="envase_arrumes_${zona}"][value="${data.envase_arrumes}"]` },
        { key: "envase_calidad", input: `input[name="envase_calidad_${zona}"][value="${data.envase_calidad}"]` },
        { key: "producto_ubicacion", input: `input[name="producto_ubicacion_${zona}"][value="${data.producto_ubicacion}"]` },
        { key: "producto_orden", input: `input[name="producto_orden_${zona}"][value="${data.producto_orden}"]` },
        { key: "producto_cortinas", input: `input[name="producto_cortinas_${zona}"][value="${data.producto_cortinas}"]` }
      ];

      fields.forEach(f => {
        const el = document.querySelector(f.input);
        if (el) el.checked = true;
      });

      const novedadTextarea = document.querySelector(`#tablaBody tr td textarea`);
      if (novedadTextarea && data.novedad) novedadTextarea.value = data.novedad;

      // Cargar im√°genes
      if (data.evidencias.derecha) {
        previewDerecha.innerHTML = `<img src="${data.evidencias.derecha}" alt="Lado derecho">`;
      }
      if (data.evidencias.izquierda) {
        previewIzquierda.innerHTML = `<img src="${data.evidencias.izquierda}" alt="Lado izquierdo">`;
      }
    }

    function mostrarPrevisualizacionDerecha() {
      const file = imagenDerecha.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewDerecha.innerHTML = `<img src="${e.target.result}" alt="Lado derecho">`;
      };
      reader.readAsDataURL(file);
    }

    function mostrarPrevisualizacionIzquierda() {
      const file = imagenIzquierda.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewIzquierda.innerHTML = `<img src="${e.target.result}" alt="Lado izquierdo">`;
      };
      reader.readAsDataURL(file);
    }

    function guardarValidacion() {
      const zona = zonaSearch.value.trim();
      if (!zonas.includes(zona)) return alert("Seleccione una zona v√°lida.");

      const aseo_cabina = document.querySelector(`input[name="aseo_cabina_${zona}"]:checked`)?.value || '';
      const aseo_carroceria = document.querySelector(`input[name="aseo_carroceria_${zona}"]:checked`)?.value || '';
      const aseo_estibas = document.querySelector(`input[name="aseo_estibas_${zona}"]:checked`)?.value || '';
      const envase_ubicacion = document.querySelector(`input[name="envase_ubicacion_${zona}"]:checked`)?.value || '';
      const envase_arrumes = document.querySelector(`input[name="envase_arrumes_${zona}"]:checked`)?.value || '';
      const envase_calidad = document.querySelector(`input[name="envase_calidad_${zona}"]:checked`)?.value || '';
      const producto_ubicacion = document.querySelector(`input[name="producto_ubicacion_${zona}"]:checked`)?.value || '';
      const producto_orden = document.querySelector(`input[name="producto_orden_${zona}"]:checked`)?.value || '';
      const producto_cortinas = document.querySelector(`input[name="producto_cortinas_${zona}"]:checked`)?.value || '';

      const novedad = document.querySelector(`#tablaBody tr td textarea`).value;

      if (!imagenDerecha.files.length || !imagenIzquierda.files.length) {
        alertaEvidencia.classList.remove("hidden");
        return;
      }

      let derecha = null, izquierda = null;

      const readerD = new FileReader();
      readerD.onload = () => {
        derecha = readerD.result;
        const readerI = new FileReader();
        readerI.onload = () => {
          izquierda = readerI.result;
          const data = {
            aseo_cabina, aseo_carroceria, aseo_estibas,
            envase_ubicacion, envase_arrumes, envase_calidad,
            producto_ubicacion, producto_orden, producto_cortinas,
            novedad,
            evidencias: { derecha, izquierda }
          };
          localStorage.setItem(`lup_validacion_${zona}`, JSON.stringify(data));
          alertaEvidencia.classList.add("hidden");
          alert(`‚úÖ Validaci√≥n guardada para ${zona}`);
        };
        readerI.readAsDataURL(imagenIzquierda.files[0]);
      };
      readerD.readAsDataURL(imagenDerecha.files[0]);
    }

    function limpiarFormulario() {
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      document.querySelectorAll('#tablaBody tr td textarea').forEach(t => t.value = '');
      previewDerecha.innerHTML = '';
      previewIzquierda.innerHTML = '';
      imagenDerecha.value = '';
      imagenIzquierda.value = '';
      alertaEvidencia.classList.add("hidden");
    }

    function generarPDF() {
      const zona = zonaSearch.value.trim();
      if (!zonas.includes(zona)) return alert("Primero seleccione una zona y guarde los datos.");

      const doc = new jspdf.jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      const totalPages = 1;

      // Encabezado
      doc.setFontSize(14);
      doc.text("DEPARTAMENTO DE EMPAQUE Y PRODUCTO", 105, 10, { align: "center" });
      doc.setFontSize(12);
      doc.text("GASEOSAS LUX SUR", 105, 15, { align: "center" });
      doc.text("INFORME DE LABOR PARA VALIDAR CUMPLIMIENTO DE CONDICIONES EN EL RECIBO DE ZONAS", 105, 20, { align: "center" });
      doc.setFontSize(10);
      doc.text("1- CUMPLE", 80, 25);
      doc.text("0- NO CUMPLE", 160, 25);
      doc.text(`FECHA: ${fechaActual.textContent}`, 10, 30);
      doc.text(`SUPERVISOR: ${supervisorInput.value || 'No especificado'}`, 10, 35);

      // Tabla principal
      const headers = [
        ["#", "ZONA", "N¬∞ VH", "CANASTILLA\nSALE - ENTRA", "ESTIBAS\nSALE-ENTRA", "REMISION\nSALE-ENTRA", "CABINA", "CARROCER√çA", "ESTIBAS", "UBICACI√ìN", "ARRUMES", "CALIDAD", "UBICACI√ìN", "ORDEN", "CORTINAS", "NOVEDAD", "EVIDENCIA"]
      ];
      const data = [];

      zonas.forEach(z => {
        const saved = localStorage.getItem(`lup_validacion_${z}`);
        if (!saved) return;

        const item = JSON.parse(saved);
        const mb51Data = mb51[z] || {};

        const row = [
          zonas.indexOf(z) + 1,
          z,
          mb51Data.vehiculo || '',
          '2',
          mb51Data.estibas || '',
          novedadesPorZona[z] ? '1' : '0',
          item.aseo_cabina || '',
          item.aseo_carroceria || '',
          item.aseo_estibas || '',
          item.envase_ubicacion || '',
          item.envase_arrumes || '',
          item.envase_calidad || '',
          item.producto_ubicacion || '',
          item.producto_orden || '',
          item.producto_cortinas || '',
          item.novedad || '',
          item.evidencias.derecha && item.evidencias.izquierda ? "üì∑" : item.evidencias.derecha || item.evidencias.izquierda ? "‚ö†Ô∏è" : "‚ùå"
        ];
        data.push(row);
      });

      // Ajustar ancho de columnas
      const colWidths = [8, 15, 15, 20, 15, 15, 10, 10, 10, 10, 10, 10, 10, 10, 10, 25, 10];

      doc.autoTable({
        head: headers,
        body: data,
        startY: 40,
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1, halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [233, 234, 239], textColor: [0, 0, 0] },
        columnStyles: { 15: { cellWidth: 30 } },
        columnWidth: colWidths,
        didDrawPage: function (data) {
          doc.setFontSize(8);
          doc.text(`P√°gina ${data.pageNumber} de ${totalPages}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });

      // Pie de p√°gina
      const y = doc.lastAutoTable.finalY + 20;
      doc.setFontSize(8);
      doc.text("¬© 2025 GASEOSAS LUX SUR ‚Äì Departamento de Empaque y Producto", 105, y, { align: "center" });

      doc.save(`REPORTE_LUP_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    // Eventos de archivos
    imagenDerecha.addEventListener("change", mostrarPrevisualizacionDerecha);
    imagenIzquierda.addEventListener("change", mostrarPrevisualizacionIzquierda);

    // Botones
    btnGuardar.addEventListener("click", guardarValidacion);
    btnLimpiar.addEventListener("click", limpiarFormulario);
    btnGenerarPDF.addEventListener("click", generarPDF);
  </script>
</body>
</html>
